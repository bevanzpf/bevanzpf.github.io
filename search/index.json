[{"content":"å‰é˜µå­çœ‹äº†å…³äºBç«™å¾®æœåŠ¡åŒ–çš„è§†é¢‘åˆ†äº«ï¼Œå¯¹å…¶ä¸­è®²åˆ°çš„æœåŠ¡å‘ç°ç›¸å…³çš„çŸ¥è¯†å°è±¡æ·±åˆ»ï¼Œåé¢å‘ç°è¿™ä¸ªç»„ä»¶æ˜¯å¼€æºçš„, äºæ˜¯éšæ‰‹cloneä¸‹æ¥å­¦ä¹ ä¸€ä¸‹ã€‚discovery æ˜¯Bç«™ä¸»ç«™ä½¿ç”¨çš„æœåŠ¡æ³¨å†Œ/å‘ç°ç»„ä»¶, å…¶è®¾è®¡å‚è€ƒæœåŠ¡æ³¨å†Œå‘ç°é¢†åŸŸçš„æ ‡æ†Netflix Eurekaå¹¶æ‰©å±•äº†ä¸€äº›ç¤¾åŒºæœŸæœ›çš„åŠŸèƒ½ï¼Œæ˜¯ä¸€å¥—çº¯ç²¹çš„APç³»ç»Ÿã€‚Discoveryå®ç°äº†APç±»å‹çš„æœåŠ¡æ³¨å†Œå‘ç°ï¼Œæ®è¯´å¯ç”¨æ€§æé«˜ï¼Œä¸‹é¢å°±æ¥è§‚æ‘©ä¸€ä¸‹æºç ï¼Œä¸€æ¢ç©¶ç«Ÿã€‚\næ¦‚å†µ \u0026hellip; TO BE CONTINUE \u0026hellip;\n","date":"2020-08-29","permalink":"https://nautilis.github.io/posts/learn-discovery-source-code/","tags":["Go","Microservices"],"title":"bilibili/discovery æºç è§£æ"},{"content":"åœ¨å¤§å‹ä¸šåŠ¡ç³»ç»Ÿä¸­æˆ‘ä»¬å¸¸å¸¸éœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œåˆ†åº“åˆ†è¡¨å¤„ç†ï¼Œæ­¤æ—¶æ•°æ®çš„å”¯ä¸€æ ‡è¯†æ— æ³•å†é€šè¿‡ä¾èµ–æ•°æ®åº“å”¯ä¸€é”®çš„æ–¹å¼å®ç°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªidæœåŠ¡è´Ÿè´£åˆ†é…å”¯ä¸€idã€‚åˆ†å¸ƒå¼idç”Ÿæˆå™¨åœ¨å¦‚ä»Šå·²ç»æ˜¯å†å¯»å¸¸ä¸è¿‡çš„éœ€æ±‚ï¼Œä¸šå†…æœ‰è®¸å¤šæˆç†Ÿçš„æ–¹æ¡ˆï¼Œæœ€å‡ºåçš„æœ‰Twitterçš„snowflakeç®—æ³•ï¼Œå›½å†…å¾ˆå¤šå¤§å‚ä¹Ÿæœ‰è‡ªå·±çš„å®ç°æ–¹æ¡ˆä¾‹å¦‚ç¾å›¢çš„Left,ç™¾åº¦çš„uid-generatorã€‚ä»Šå¤©æˆ‘ä»¬é€šè¿‡Redisæ¥å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼IDç”Ÿæˆå™¨ï¼Œè¦æ±‚æ¯”è¾ƒç®€å•ï¼Œé™¤äº†idè¦å”¯ä¸€,æ”¯æŒåˆ†å¸ƒå¼ï¼Œè¿˜è¦ä¿è¯å®šé•¿è·Ÿæ— åºã€‚\nå®ç°æ–¹æ³•  å¤šå°æœºå™¨IDä¿æŒå”¯ä¸€ï¼šidé€šè¿‡æ•°å­—æ˜ å°„åˆ°35ä¸ªæ•°å­—å­—æ¯ç»„æˆ(1-9,a-z, 0ä½œä¸ºè¡¥ä½), æ•´ä¸ªidåˆ†ä¸ºä¸¤æ®µï¼Œå‰æ®µ4ä½å­—ç¬¦ç”±å½“å‰æ—¶é—´è·ŸæœåŠ¡çš„èµ·å§‹æ—¶é—´åšå·®ä»¥åŠæœºå™¨ç¼–å·å†³å®šï¼Œåæ®µ5ä½å­—ç¬¦åˆ™é€šè¿‡éšæœºç”Ÿæˆæ•°å­—å†é€šè¿‡Redisçš„bitmapæ’é‡ã€‚æ’é‡çš„keyä½¿ç”¨idçš„å‰æ®µæ ‡è¯†ï¼Œredis bitmapå¯ä»¥æœ€å¤šå¯ä»¥æ ‡è®°2^32-1ï¼Œåæ®µä½æ•°ä¸º5å…±35^5=52521875ä¸ªéšæœºæ•°,å‡å¦‚å¹¶å‘é«˜åˆ°10000tpsä¸€ä¸ªå°æ—¶å†…ä¹Ÿä¸ä¼šè¶…è¿‡52521875äº†ã€‚ å•ä¸ªè¿›ç¨‹ä¸­IDçš„å­˜å–ï¼šé€šè¿‡channelå­˜å‚¨ç”Ÿæˆçš„id, å½“channelæ»¡æ—¶ä¼‘çœ ï¼Œchannelè¢«æ¶ˆè´¹æœ‰å‰©ä½™ç©ºé—´æ—¶è¡¥å……idã€‚  package main import ( \u0026quot;bytes\u0026quot; \u0026quot;context\u0026quot; \u0026quot;github.com/go-redis/redis\u0026quot; \u0026quot;log\u0026quot; \u0026quot;math/rand\u0026quot; \u0026quot;os\u0026quot; \u0026quot;strconv\u0026quot; \u0026quot;sync\u0026quot; \u0026quot;time\u0026quot; ) var redisClient *redis.Client type IdGenerate struct { base35code []byte startTime int64 machineCode int //æœåŠ¡å™¨ç¼–ç (é€šè¿‡hostnameåç¼€è·å–ï¼‰ redisClient *redis.Client random *rand.Rand idChannel chan string //å­˜å‚¨ç”Ÿæˆidçš„ç®¡é“ } func NewIdGenerate() *IdGenerate { inst := \u0026amp;IdGenerate{ startTime: 1596782020, random: rand.New(rand.NewSource(time.Now().Unix())), idChannel: make(chan string, 10000), } hostName, _ := os.Hostname() machineId, _ := strconv.Atoi(hostName[len(hostName)-2:]) inst.machineCode = machineId base35Code := \u0026quot;123456789qwertyuioplkjhgfdsazxcvbnm\u0026quot; inst.base35code = []byte(base35Code) redisClient := redis.NewClient(\u0026amp;redis.Options{ Addr: \u0026quot;127.0.0.1:6379\u0026quot;, }) inst.redisClient = redisClient return inst } //å°†æ•°å­—æ˜ å°„æˆå­—æ¯æ•°å­—ç»„åˆå­—ç¬¦ä¸² func (this *IdGenerate) getBase35Code(num int64) string { codeLen := int64(len(this.base35code)) buf := bytes.Buffer{} for { c := this.base35code[num%codeLen] buf.WriteByte(c) num = num / codeLen if num \u0026lt;= 0 { break } } return buf.String() } //å½“å‰æ—¶é—´ä¸æœåŠ¡èµ·å§‹æ—¶é—´åšå·®æ¥ç¡®å®šä¸€ä¸ªæ’é‡key func (this *IdGenerate) getDistinctKey() string { key := this.getBase35Code((time.Now().Unix()-this.startTime)/3600*100 + int64(this.machineCode)) //*100 é¢„ç•™ä¸¤ä½ç»™æœºå™¨id pack := bytes.Buffer{} if len(key) \u0026lt; 4 { //ä¸è¶³å››ä½é€šè¿‡0è¡¥é½ for i := len(key); i \u0026lt; 4; i++ { pack.WriteByte('0') } } pack.WriteString(key) return pack.String() } //é€šè¿‡bitmapè¿‡æ»¤ä¸æ–­çš„å°è¯•ç”Ÿæˆæ–°id func (this *IdGenerate) genId() string { distinctKey := this.getDistinctKey() c, err := this.redisClient.BitCount(context.Background(), distinctKey, nil).Result() if err != nil { log.Print(err.Error()) } if c == 0 || c%100 == 0 { //è®¾ç½®æ–°key 2å°æ—¶åè¿‡æœŸï¼Œè¿™é‡Œæ€•ä¸€æ¬¡è®¾ç½®å¯èƒ½å¤±è´¥æ•…æ²¡åœ¨bitmap æ¯æ ‡è®°100ä¸ªå°±é‡æ–°è®¾ç½®ä¸€æ¬¡è¿‡æœŸ this.redisClient.Expire(context.Background(), distinctKey, 2*time.Hour) } var id int for { id = this.random.Intn(35) + 1 for i := 0; i \u0026lt; 4; i++ { r := this.random.Intn(35) + 1 id = id * r } val, err := this.redisClient.GetBit(context.Background(), distinctKey, int64(id)).Result() if err != nil { log.Print(\u0026quot;access redis error: \u0026quot; + err.Error()) } if val == 0 { _, err := this.redisClient.SetBit(context.Background(), distinctKey, int64(id), 1).Result() if err != nil { log.Println(err.Error()) continue } break } } randomPart := this.getBase35Code(int64(id)) b := bytes.Buffer{} b.WriteString(distinctKey) b.WriteString(randomPart) if len(randomPart) \u0026lt; 5 { for i := len(randomPart); i \u0026lt; 5; i++ { b.WriteByte('0') } } return b.String() } //å¾ªç¯ä¸æ–­ç”Ÿæˆidçš„æ–¹æ³• func (this *IdGenerate) provideId() { useOld := false var id string for { if !useOld { id = this.genId() } select { case this.idChannel \u0026lt;- id: log.Println(\u0026quot;add id:\u0026quot;, id) useOld = false default: useOld = true time.Sleep(2 * time.Second) } } } //è·å–id func (this *IdGenerate) ConsumeId(size int) (res []string) { //æ€»çš„è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º100ms eachTimeOut := time.Duration(100/size) * time.Millisecond res = make([]string, size) for i := 0; i \u0026lt; size; i++ { select { case id := \u0026lt;-this.idChannel: res = append(res, id) case \u0026lt;-time.After(eachTimeOut): log.Println(\u0026quot;access id time\u0026quot;) } } return res } func main() { generator := NewIdGenerate() wg := sync.WaitGroup{} wg.Add(2) go func() { generator.provideId() wg.Done() }() for i := 0; i \u0026lt; 10; i++ { go func() { for { ids := generator.ConsumeId(3) log.Println(\u0026quot;consume ids:\u0026quot;, ids) time.Sleep(1 * time.Second) } }() } wg.Wait() }  ","date":"2020-08-15","permalink":"https://nautilis.github.io/posts/gen-unique-by-redis/","tags":["redis","Go"],"title":"å¾’æ‰‹æ’¸ä¸€ä¸ªåˆ†å¸ƒå¼idç”Ÿæˆå™¨"},{"content":"ä½œä¸ºä¸€ä¸ªæœåŠ¡ç«¯å¼€å‘äººå‘˜ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰åŠå¤œè¢«çªç„¶çš„å‘Šè­¦æƒŠé†’çš„ç»å†ï¼Œä¹Ÿä¼šæœ‰é¢ä¸´å‘ç”Ÿé—®é¢˜æ‰‹å¿™è„šä¹±æ— ä»ä¸‹æ‰‹çš„æ—¶æœŸï¼Œè¿™ç¯‡æ–‡ç« å›é¡¾äº†è¿‘æœŸæˆ‘æ’æŸ¥ä¸€ä¸ªçº¿ä¸Šæ€§èƒ½é—®é¢˜çš„è¿‡ç¨‹ã€‚\nèƒŒæ™¯ æˆ‘ä¸»è¦è´Ÿè´£çš„ä¸€ä¸ªçº¿ä¸ŠæœåŠ¡åœ¨å¤œæ·±äººé™çš„æŸå¤©è°ƒç”¨æ–¹çªç„¶å‘ŠæœåŠ¡è¶…æ—¶,ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°é«˜åˆ†æœŸï¼ˆ23ç‚¹åˆ°å‡Œæ™¨2ç‚¹ï¼‰å“åº”æ—¶é—´ä¸¥é‡çš„å·²ç»è¶…è¿‡100msã€‚è¿™æ˜¯ä¸€ä¸ªè¾ƒä¸ºåº•å±‚çš„æœåŠ¡ï¼Œä¸»è¦ä¸ºç”¨æˆ·feedæµæä¾›æ‰¹é‡ç”¨æˆ·å±æ€§æŸ¥è¯¢è·Ÿç”¨æˆ·å…³ç³»æŸ¥è¯¢(è·å–feedæµå†…å®¹ä½œè€…å±æ€§ä»¥åŠå½“å‰ç”¨æˆ·æ˜¯å¦å…³æ³¨è¿™äº›ä½œè€…ï¼‰ã€‚ä¸¤ç§æ•°æ®çš„è·å–é€šè¿‡å†…éƒ¨è°ƒç”¨å¦ä¸€ä¸ªåº•å±‚æœåŠ¡å®ç°ï¼Œå¯¹äºç”¨æˆ·å±æ€§ï¼ŒæœåŠ¡ç«¯å…ˆé€šè¿‡mgetè·å–ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œç¼“å­˜ä¸å‘½ä¸­çš„æƒ…å†µä¸‹å¹¶å‘æŸ¥è¯¢æ•°æ®åº“å†æ±‡æ€»è¿”å›ï¼›ç”¨æˆ·å…³ç³»ï¼Œä¹Ÿæ˜¯å…ˆæŸ¥è¯¢ç¼“å­˜å†é€šè¿‡pipelineæŸ¥è¯¢æŒä¹…æ¢ç¼“å­˜ã€‚æœºå™¨éƒ¨ç½²äº†9å°ï¼Œå…¶ä¸­1å°4æ ¸ï¼Œå…¶ä»–éƒ½æ˜¯2æ ¸ã€‚\nåˆæ­¥æ’æŸ¥  çº¿ä¸Šæ— æ–°å¢ä»£ç ï¼Œè¿›ç¨‹ä¹Ÿæ˜¯å‡ å¤©å‰çš„ï¼Œæ’é™¤æ–°ä»£ç é—®é¢˜ã€‚ pvçªç„¶å¢é•¿äº†ç»20%, æŸ¥çœ‹æœºå™¨è´Ÿè½½å‘ç°cpu,å†…å­˜ï¼Œloadéƒ½å¾ˆæ­£å¸¸ï¼Œä¾èµ–çš„Redisè·ŸRDSä¹Ÿæ²¡æœ‰è¶…æ°´ä½å‘Šè­¦ã€‚ çœŸæ˜¯è§é¬¼ï¼Œä»¥å¾€çš„æ’æŸ¥æ–¹å¼å±…ç„¶æ²¡æœ‰ä¸€ä¸çº¿ç´¢\u0026hellip; äºæ˜¯æˆ‘è§‰å¾—è‡ªå·±åŠ ä¸Šè€—æ—¶æ‰“ç‚¹ï¼Œç„¶åé€šè¿‡è„šæœ¬é‡‡é›†ä¸‹è€—æ—¶æƒ…å†µã€‚  é‡‡é›†  æ¥å£åŠ å…¥æ‰“ç‚¹ç»Ÿè®¡ä¸åŒæœºå™¨ä¸Šçš„mgetè€—æ—¶ï¼Œredisæœªå‘½ä¸­æ•°ï¼Œ dbå¹¶å‘æŸ¥è¯¢è€—æ—¶ åœ¨è´Ÿè½½ä¸é«˜çš„æœºå™¨åˆ†å›ºå®šuid è·Ÿéšæœºuidä¸¤ç»„è¯·æ±‚æ¥å£è·å–è€—æ—¶æ•°æ®ï¼ŒåŒæ—¶æœ¬åœ°ç›´æ¥è¿æ¥redisè°ƒç”¨mgetç»Ÿè®¡è€—æ—¶ã€‚  æ•°æ®åˆ†æ  è®¡ç®—æ¯åˆ†é’Ÿå„é¡¹æ•°æ®è€—æ—¶çš„å¹³å‡å€¼(è¿™é‡Œèµ°äº†ä¸ªå¼¯è·¯ğŸ˜°) å¯¹æ¯”ä¸åŒæœºå™¨ä¸Šçš„mgetè€—æ—¶ï¼Œçœ‹æ˜¯ä¸æ˜¯ä¸ªåˆ«æœºå™¨çš„é—®é¢˜ã€‚ å¯¹æ¯”åŒæ—¶éœ€è¦è¯·æ±‚Redisè·ŸDBæ—¶ï¼Œäº†è§£mgetè·Ÿdbçš„è€—æ—¶åå·®ã€‚ å¯¹æ¯”æœåŠ¡mgetè·Ÿæœ¬åœ°mgetè€—æ—¶ï¼ŒéªŒè¯Redisè€—æ—¶æƒ…å†µæ˜¯å¦å¦‚å®ã€‚  ä»¥ä¸‹å›¾æ ‡xè½´ä¸ºæ—¶é—´ï¼ˆåˆ†é’Ÿçº§ï¼‰yè½´ä¸ºè€—æ—¶ï¼ˆå•ä½ms) ä¸Šé¢è¿™å¼ å°±æ˜¯ä¸åŒæœºå™¨çš„mgetè€—æ—¶æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºmgetè€—æ—¶ç¡®å®å­˜åœ¨é«˜å³°æœŸæ•ˆåº”å¹¶ä¸”ä¸å­˜åœ¨ä¸ªåˆ«æœºå™¨è€—æ—¶åç¦»è¾ƒå¤§çš„æƒ…å†µï¼Œæ‰€ä»¥æ’é™¤ä¸ªåˆ«æœºå™¨çš„é—®é¢˜ã€‚\nåœ¨åŒæ—¶éœ€è¦æŸ¥Redisè·ŸDBçš„è¯·æ±‚ä¸­ï¼ŒDBè€—æ—¶æ˜æ˜¾é«˜äºRedis,ä½†è¿™æ˜¯å¯é¢„è§çš„ï¼Œé«˜ä½å³°ä¸¤ä¸ªæ›²çº¿çš„æ³¢åŠ¨ä»è¿™ä¸ªå›¾ä¸Šçœ‹ä¸æ˜æ˜¾ï¼Œè¿›ä¸€æ­¥é€šè¿‡æŠ½æŸ¥æœåŠ¡çš„æ‰“ç‚¹æ—¥å¿—å¯ä»¥çœ‹åˆ°3ä¸‡ä¸ªè¯·æ±‚ä¸­éœ€è¦æŸ¥è¯¢DBçš„åªæœ‰16ä¸ªï¼Œè¯´æ˜feedæµè·å–çš„ç”¨æˆ·åŸºæœ¬éƒ½æ˜¯ç¼“å­˜åˆ°Redisçš„çƒ­æ•°æ®ï¼Œæ’é™¤DBå¼•å‘é«˜è€—æ—¶,è¿›ä¸€æ­¥è§‚å¯ŸRedisçš„æ•°æ®ã€‚\nä¸Šé¢è¿™å¼ å›¾å·¦è¾¹æ˜¯å‡ºé—®é¢˜çš„æœåŠ¡å†…éƒ¨mgetï¼Œå³è¾¹æ˜¯ä½è´Ÿè½½æœåŠ¡å™¨ä¸Šä½¿ç”¨åŒä¸ªRedisé›†ç¾¤çš„mgetè¡¨ç°ã€‚ä¸¤è€…å‘ˆç°ç›¸åŒçš„åˆ†å¸ƒè¶‹åŠ¿ï¼ŒRedisé«˜å³°æœŸç¡®å®å“åº”å˜æ…¢ã€‚\né€šè¿‡ä»¥ä¸Šçš„ä¸€è½®åˆ†æï¼Œé¦–å…ˆæ’é™¤äº†ä¸ªåˆ«æœºå™¨çš„é—®é¢˜ä»¥åŠDBçš„é—®é¢˜ï¼Œä¼¼ä¹é—®é¢˜å°±æ˜¯Redisæ…¢äº†å¯¼è‡´çš„ã€‚ä½†æ˜¯ï¼Œä¸å¯¹å•Šï¼ŒRedisè€—æ—¶è™½ç„¶é«˜å³°æœŸå˜æ…¢ä½†æ˜¯8msä¹Ÿå¹¶ä¸è‡³äºå¯¼è‡´100+msçš„å‘Šè­¦ï¼Œå¦å¤–Redisçš„æ€§èƒ½æ˜¯å¤§å®¶å…¬è®¤çš„ã€‚ åé¢ç»è¿‡å’ŒåŒäº‹çš„ä¸€ç•ªæ¢è®¨ï¼Œæ”¶è·äº†ä¸€ä¸ªé‡è¦çš„çŸ¥è¯†\u0026ndash;æ’æŸ¥é—®é¢˜çš„æ—¶å€™ä¸€èˆ¬çœ‹æœ€å¤§å€¼ï¼Œå¦å¤–ä¹Ÿè¿˜å‘ç°æˆ‘æ¼åˆ†æäº†ä¸­è½¬çš„è€—æ—¶ã€‚\nä¸Šé¢è¿™å¼ å°±æ˜¯åæ¥è¡¥çš„ä¸­è½¬è€—æ—¶è¶‹åŠ¿å›¾ï¼ˆæŒ‰æ¯åˆ†é’Ÿå–æœ€å¤§å€¼å¤„ç†ï¼‰ï¼Œä¸­è½¬æœ€å¤§è€—æ—¶ä¹Ÿä¸è¿‡2msï¼Œæ˜¾ç„¶ä¹Ÿä¸æ˜¯ä¸­è½¬å¯¼è‡´çš„ã€‚\nç»§ç»­å¯¹ä¹‹å‰çš„æ•°æ®åšæœ€å¤§å€¼å¤„ç†ï¼Œåœ¨æœåŠ¡ç«¯mgetè·Ÿæœ¬åœ°mgetè¿™ç»„é˜Ÿæ¯”ä¸­æˆ‘ä»¬å‘ç°äº†å¼‚å¸¸ğŸ‘‡\nåœ¨å–æœ€å¤§å€¼çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡çš„mgetè€—æ—¶é«˜å³°æœŸæ™®éåˆ°è¾¾80msä»¥ä¸Šï¼Œè€Œç›´æ¥è¿Redisçš„å¯¹ç…§ç»„åˆ™ååˆ†å¹³ç¨³æ²¡æœ‰é«˜å³°æ•ˆåº”ã€‚è¿™ååˆ†è®©äººä¸è§£ï¼Œæˆ‘çš„è„šæœ¬è¿æ¥Redisè·ŸæœåŠ¡å™¨çš„è¡¨ç°å®Œå…¨å¯¹ä¸ä¸Šäº†ï¼Œå¤ªå¥‡æ€ªäº†ï¼Œæ˜¯æ—¶å€™åˆ†æä¸‹ä»£ç äº†ã€‚\næŸ¥çœ‹ä»£ç   æˆ‘çš„è„šæœ¬è·ŸæœåŠ¡å™¨éƒ½æ˜¯é€šè¿‡è¿™æ ·çš„æ–¹å¼è·å–Rediså®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯åˆ°åº•æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿoptioné‡Œåˆ°åº•æœ‰ä»€ä¹ˆï¼Ÿ   é€šè¿‡å¯¹ä»£ç çš„è¿›ä¸€æ­¥æŸ¥çœ‹ï¼Œå‘ç°è¿™ä¸ªRediså®¢æˆ·ç«¯æ˜¯ç»´æŠ¤äº†ä¸€ç»„Redisé“¾æ¥æ± çš„ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªpoolSizeçš„å‚æ•°è®¾ç½®é“¾æ¥æ± çš„å¤§å°ï¼Œé»˜è®¤å¤§å°æ˜¯10*CPUæ•°ã€‚è¿™ä¸‹æˆ‘ä»¬æœ‰äº†çº¿ç´¢ï¼Œåˆæ­¥æ€€ç–‘è¿æ¥ä¸å¤Ÿç”¨ï¼Œç»§ç»­çœ‹ä»£ç ï¼Œå‘ç°è¿æ¥æ± æ— ç©ºé—²è¿æ¥çš„æ—¶å€™é»˜è®¤çš„ç­‰å¾…è¶…æ—¶å±…ç„¶è¾¾1ç§’é’Ÿï¼Œè¿™æ›´åŠ å†³å®šäº†æˆ‘çš„æ€€ç–‘ï¼Œåç»­æˆ‘åŠ äº†ä¸ªç©ºé—²è¿æ¥æ•°çš„å¸¦ç‚¹ä¹Ÿç¡®å®éªŒè¯äº†é«˜å³°æœŸè¿æ¥æ•°è€—å°½çš„æƒ…å†µã€‚  è§£å†³  ä¿®æ”¹é»˜è®¤è¿æ¥æ± æ•°ç›®ï¼Œå› ä¸ºé€šè¿‡ä»£ç å‘ç°è¿™ä¸ªè¿æ¥æ•°æ˜¯æœ‰è‡ªåŠ¨å›æ”¶æœºåˆ¶çš„ï¼Œè¿æ¥ç©ºé—²è¶…è¿‡ä¸€å®šæ—¶é—´å°±ä¼šè¢«å›æ”¶ã€‚  æ€»ç»“  é‡‡ç”¨è€—æ—¶æ‰“ç‚¹çš„æ–¹å¼å¯ä»¥å¾ˆå¿«å®šä½é—®é¢˜çš„ä½ç½®ã€‚ è®¾ç½®åˆç†çš„å¯¹ç…§ç»„æœ‰åˆ©äºä½“ç°æ•°æ®å¼‚å¸¸ä»ä¸­æ‰¾åˆ°çº¿ç´¢ã€‚ åˆ†ææ€§èƒ½é—®é¢˜æ—¶è¦çœ‹æœ€å¤§å€¼ï¼Œå¹³å‡å€¼ä¼šæ©ç›–æ‰çœŸå®æƒ…å†µã€‚ æœ€åè¦è€å¿ƒåœ°åˆ†æä»£ç å°è¯•åˆ°æ•°æ®èƒŒåçš„çœŸç›¸ã€‚  ","date":"2020-07-31","permalink":"https://nautilis.github.io/posts/record-server-optimization/","tags":["redis"],"title":"è®°ä¸€æ¬¡æœåŠ¡ç«¯æ€§èƒ½ä¼˜åŒ–"},{"content":"SSHæ˜¯ä»€ä¹ˆ ssh æ˜¯ä¸€ç§åŠ å¯†ç½‘ç»œåè®®ï¼Œé€šè¿‡å»ºç«‹å®‰å…¨éš§é“æ¥è¿›è¡Œå®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡ï¼Œé€šå¸¸ç”¨äºè¿œç¨‹ç™»å½•ï¼Œä½†å®é™…ä¸Šä»»ä½•ç½‘ç»œæœåŠ¡éƒ½å¯ä»¥é€šè¿‡sshè¿›è¡Œå®‰å…¨ä¼ è¾“ã€‚\nåˆ©ç”¨SSH è¿›è¡Œç§‘å­¦ä¸Šç½‘  å¦‚æœä½ æ°å·§æœ‰ä¸€å°æµ·å¤–æœåŠ¡å™¨ï¼Œå¯ä»¥åˆ©ç”¨sshè¿›è¡ŒåŠ¨æ€ç«¯å£è½¬å‘ä»è€Œå®ç°ç§‘å­¦ä¸Šç½‘ã€‚ ssh -p your_ssh_port -f -N -D 0.0.0.0:8000 username@remote_host è¿™ä¸ªå‘½ä»¤å¯åŠ¨socketç›‘å¬æœ¬åœ°ç«¯å£8000,å°†æ‰€æœ‰å‘é€åˆ°çš„æ•°æ®é€šè¿‡sshåè®®ä¸è¿œç¨‹ä¸»æœºè¿›è¡Œé€šä¿¡ã€‚ å¼€å¯åŠ¨æ€ç«¯å£è½¬å‘åï¼Œé€šè¿‡SwitchyOmegaç­‰ä»£ç†æ’ä»¶å°†æµè§ˆå™¨æ•°æ®è½¬å‘åˆ°æœ¬åœ°ç«¯å£8000å³å¯ã€‚ å®šæ—¶é‡å¯è„šæœ¬ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯è¶…æ—¶é…ç½®é—®é¢˜ï¼Œsshä¼šæ—¶ä¸æ—¶æ–­çº¿ï¼Œéœ€è¦é‡å¯ï¼Œæ‰€ä»¥å°±å†™äº†ä¸ªpythonè„šæœ¬åŠ åˆ°crontabã€‚  import subprocess import os import re ''' é€šè¿‡ ps -ef | grep ssh\\ -p\\ 22\\ -f\\ -N | grep -v grep | awk '{print $2}' æ‰¾åˆ°å¯åŠ¨çš„è¿›ç¨‹ï¼Œæ‰§è¡Œ killï¼Œ é‡å¯sshè½¬å‘å‘½ä»¤ã€‚ ''' try: ps = subprocess.Popen(('ps', '-ef'), stdout=subprocess.PIPE) grep = subprocess.Popen(('grep', 'ssh\\ -p\\ 22\\ -f\\ -N' ), stdin=ps.stdout, stdout=subprocess.PIPE) awk = subprocess.check_output(('awk', '{print $2}'), stdin=grep.stdout) ps.wait() grep.wait() print(awk) except: command = \u0026quot;ssh -p 22 -f -N -D 0.0.0.0:8000 username@remote_ip\u0026quot; os.system(command) exit() pids = [p for p in awk.split('\\n') if re.match(\u0026quot;^\\d\u0026quot;, p)] for pid in pids: print(\u0026quot;to kill...%s\u0026quot; % (pid)) subprocess.check_output([\u0026quot;kill\u0026quot;, pid]) command = \u0026quot;ssh -p 22 -f -N -D 0.0.0.0:8000 username@remote_ip\u0026quot; os.system(command)   ç”¨shell æ›´å°‘ä»£ç   #!/usr/bin pids=(`ps -ef | grep 'ssh -p 22 -f -N' | grep -v 'grep' | awk '{print $2}'`) echo $pids for p in $pids do kill -9 $p\tdone ssh -p 22 -f -N -D 0.0.0.0:1090 root@remote_ip  ","date":"2019-06-10","permalink":"https://nautilis.github.io/posts/access-google/","tags":["ssh"],"title":"ç§‘å­¦ä¸Šç½‘ä¹‹ssh"},{"content":"è®°å½•Java8çš„ä¸€äº›è¯­æ³•ğŸ¬\nList to Map @Data @AllArgsConstructor @ToString class People { private String name; private int age; private String lastName; } @Test public void testStream() { List\u0026lt;People\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); list.add(new People(\u0026quot;nautilis\u0026quot;, 25, \u0026quot;zheng\u0026quot;)); list.add(new People(\u0026quot;nautilis\u0026quot;, 25, \u0026quot;zheng\u0026quot;)); list.add(new People(\u0026quot;bevan\u0026quot;, 25, \u0026quot;zheng\u0026quot;)); list.add(new People(\u0026quot;ning\u0026quot;, 24, \u0026quot;li\u0026quot;)); //é‡å¤keyåªä¿ç•™ä¸€ä¸ªï¼Œ å¹¶ç”¨linkedHashMapä¿è¯é¡ºåº Map\u0026lt;String, People\u0026gt; map = list.stream().sorted(Comparator.comparing(People::getAge).reversed()) .collect(Collectors.toMap(People::getName, Function.identity(), (oldv, newV) -\u0026gt; newV, LinkedHashMap::new )); System.out.printf(\u0026quot;é‡å¤keyåªä¿ç•™ä¸€ä¸ªï¼Œ å¹¶ç”¨linkedHashMapä¿è¯é¡ºåº---\u0026gt;\u0026quot;); map.forEach((k, v) -\u0026gt; System.out.println(k + \u0026quot;:\u0026quot; + v)); //å§“æ°#=\u0026gt;äººåˆ—è¡¨ Map\u0026lt;String,List\u0026lt;People\u0026gt;\u0026gt; lastPeopleMap = list.stream() .collect(Collectors.groupingBy(People::getLastName)); System.out.println(\u0026quot;å§“æ°#=\u0026gt;äººåˆ—è¡¨ ---\u0026gt;\u0026quot;); lastPeopleMap.forEach((k, v) -\u0026gt; System.out.println(k + \u0026quot; : \u0026quot; + v)); //å§“æ°#=\u0026gt; äººååˆ—è¡¨ Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; lastnameNamelistMap = list.stream() .collect(Collectors.groupingBy(People::getLastName, Collectors.mapping(People::getName, Collectors.toList()))); System.out.println(\u0026quot;å§“æ°#=\u0026gt; äººååˆ—è¡¨---\u0026gt;\u0026quot;); lastnameNamelistMap.forEach((k, v) -\u0026gt; System.out.println(k + \u0026quot; : \u0026quot; + v)); // å§“æ°#=\u0026gt;äººåé›†åˆ Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; lastnameNameSet = list.stream() .collect(Collectors.groupingBy(People::getLastName, Collectors.mapping(People::getName, Collectors.toSet()))); System.out.println(\u0026quot;å§“æ°#=\u0026gt;äººåé›†åˆ---\u0026gt;\u0026quot;); lastnameNameSet.forEach((k, v) -\u0026gt; System.out.println(k + \u0026quot; : \u0026quot; + v)); }  ","date":"2019-05-18","permalink":"https://nautilis.github.io/posts/java8/","tags":["Java"],"title":"Java8è¯­æ³•ç³–"},{"content":" ç«¯å£è½¬å‘Â http://www.dshowing.com/2017/08/14/SSH_portforward/Â æœ¬åœ°å¯åŠ¨ssh:ssh -p [serverport] -f -N -D 0.0.0.0:[socksport] username@remoteaddressÂ chromeä¸Šç”¨proxy switchysharp æˆ–è€… firefox ç”¨FoxyProxy é…ç½®ä¸€ä¸ªsocks5 IP:127.0.0.1 ç«¯å£ä¸ºæ‰€å¡«çš„socksportã€‚ ssh -o PubkeyAuthentication=no 120.24.161.131  ä¸ç”¨ssh key ssh -f åå°è¿è¡Œ -N ä¸å‘é€å‘½ä»¤ -f -N å‚æ•° ssh -f -N -L localport:host1:port1 host3 host2æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œ host2ç™»å½•host3 æœ¬åœ°ç«¯å£è½¬å‘ -L æ¥è‡ªhost3èµ°localhostçš„æ•°æ®å‘é€åˆ°host1çš„port1 è¿œç¨‹ç«¯å£è½¬å‘ ssh -f -N -R remotePort:host1:port1 host3 åœ¨host2æ‰§è¡Œæ­¤å‘½ä»¤è¡¨ç¤º åœ¨host2ç™»å½•host3 ä»¤ host3ç›‘å¬ remotePort, host2å°†host3å‘åˆ° remotePort çš„æ•°æ®è½¬å‘åˆ°host1:prot1 æœ¬åœ°ç«¯å£è½¬å‘ä½¿ç”¨åœºæ™¯ host3å¯ä»¥è¿host2, host2èƒ½è¿host1,host3ä¸èƒ½è®¿é—®host1, å¯é€šè¿‡host2åšæœ¬åœ°ç«¯å£è½¬å‘ã€‚ è¿œç¨‹ç«¯å£è½¬å‘ï¼Œç”¨äºå†…ç½‘ç©¿é€ï¼Œ host1 host2åœ¨å†…ç½‘ï¼Œhost2å¯è®¿é—®å¤–ç½‘çš„host3, host3æ— æ³•è®¿é—®å†…ç½‘ï¼Œå¯ä»¥åœ¨host2åšè¿œç¨‹ç«¯å£è½¬å‘ï¼Œä½¿host3çš„æ•°æ®å‘é€åˆ°å†…ç½‘ã€‚ ssh -f -N -L localport:localhost:port host3 localhostæŒ‡çš„æ˜¯host3, localhost æ˜¯ç›¸å¯¹host3çš„ã€‚  ","date":"2019-03-21","permalink":"https://nautilis.github.io/posts/ssh-note/","tags":["ssh"],"title":"ssh ç¬”è®°"},{"content":"å½’å¹¶æ’åº  å½’å¹¶æ’åºæ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œçš„åŸºç¡€ä¹‹ä¸Šçš„ã€‚å¦‚æœä¸¤ä¸ªæ•°ç»„éƒ½æ˜¯æœ‰åºæ•°ç»„ï¼Œåªéœ€è¿­ä»£ä¸¤ä¸ªæ•°ç»„ï¼Œä¸æ–­æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„å…ƒç´ ï¼Œå°†è¾ƒå°çš„æ’åˆ°å‰é¢å³å¯ã€‚å½’å¹¶æ’åºé¦–å…ˆé€šè¿‡é€’å½’å¯¹æ•°ç»„è¿›è¡Œå¯¹ç­‰åˆ†å‰²ï¼Œç›´åˆ°åˆ†å‰²çš„éƒ¨åˆ†åªæœ‰ä¸€ä¸ªå…ƒç´ (ç›¸é‚»ä¸¤ä¸ªæ•°ç»„å¿…å®šæœ‰åºï¼‰è¿›è¡Œåˆå¹¶æ“ä½œã€‚  #include\u0026lt;stdio.h\u0026gt; void show(int arr[], int n){ int i; for( i=0; i\u0026lt;n; i++) printf(\u0026quot;%d, \u0026quot;, arr[i]); printf(\u0026quot;\\n\u0026quot;); }\t//åˆå¹¶ç®—æ³• void merge(int array[], int left, int mid, int right){ int aux[right+1]; //ä¸´æ—¶æ•°ç»„ //ä»ä¸­é—´æ–­å¼€ä¸¤ä¸ªæ ‡å¿—åˆ†åˆ« int i = left; int j = mid + 1; int k; for( k=left; k\u0026lt;=right; k++ ) //å¤åˆ¶æ•°ç»„ aux[k] = array[k]; for( k=left; k\u0026lt;=right; k++ ){ if(i \u0026gt; mid) //å·¦è¾¹æŒ‡é’ˆå·²è¶…å‡º array[k] = aux[j++]; else if(j \u0026gt; right) //å³è¾¹æŒ‡é’ˆè¶…å‡º array[k] = aux[i++]; else if(aux[j] \u0026lt; aux[i]) //éƒ½æ²¡æœ‰è¶…å‡ºå°±æ¯”è¾ƒä¸¤è€…å¤§å° array[k] = aux[j++]; else array[k] = aux[i++]; } } void sort(int array[], int left, int right){ if(left \u0026gt;= right) return;\tint mid = left + (right - left) / 2; sort(array, left, mid); sort(array, mid+1, right); merge(array, left, mid, right); } int main() { int arr_test[] = { 8, 2, 19, 4, 5, 11, 23, 44, 12, 31 }; int size = sizeof(arr_test)/sizeof(arr_test[0]); printf(\u0026quot;%s \\n\u0026quot;, \u0026quot;before sort:\u0026quot;); show(arr_test, size); sort(arr_test, 0, size-1);\tprintf(\u0026quot;%s \\n\u0026quot;, \u0026quot;after sorted:\u0026quot;); show(arr_test, size); return 0; }  å¿«é€Ÿæ’åº  å¿«é€Ÿæ’åºæ˜¯å»ºç«‹åœ¨åˆ’åˆ†åŸºç¡€ä¸Šçš„ï¼Œåˆ’åˆ†è¿‡ç¨‹é€‰å–ä¸€ä¸ªæ•°ç»„æˆå‘˜ä½œä¸ºæ¯”è¾ƒå°†æ•°ç»„åˆ’åˆ†æˆå¤§äºè¿™æ¯”è¾ƒç›®æ ‡å’Œå°äºè¿™ä¸ªæ¯”è¾ƒç›®æ ‡çš„ä¸¤éƒ¨åˆ†,å¯¹æ•°ç»„ä¸æ–­çš„é€’å½’åˆ’åˆ†æœ€ç»ˆæ•°ç»„å³æ˜¯æœ‰åºçš„ã€‚  #include\u0026lt;stdio.h\u0026gt; void show(int arr[], int size) { int i; for(i=0;i\u0026lt;size;i++) printf(\u0026quot;%d \u0026quot;, arr[i]); printf(\u0026quot;\\n\u0026quot;); } void exch(int arr[], int i, int j) { int temp = arr[i]; arr[i] = arr[j]; arr[j] = temp; } int partition(int arr[], int left, int right) { int v = arr[left]; int i = left; //å‘å‰æ‰«çš„æŒ‡é’ˆ int j = right + 1; //å‘åæ‰«æŒ‡é’ˆ while(1){ while(arr[++i] \u0026lt; v) if(i == right)//å‰æ‰«æŒ‡é’ˆå·²åˆ°ä½ break; while(arr[--j] \u0026gt; v) if(j == left) //åæ‰«æŒ‡é’ˆå·²åˆ°ä½ break; if(i\u0026gt;=j)// ä¸¤ä¸ªæŒ‡é’ˆç›¸é‡ break;\texch(arr, i, j); //while å¾ªç¯åœä¸‹æ¥äº¤æ¢å…ƒç´  } exch(arr, left, j); return j; } void sort(int arr[], int left, int right) { if(left \u0026gt;= right) return; int j = partition(arr, left, right); sort(arr, left, j); sort(arr, j+1, right); } void quickSort(int arr[], int size) { sort(arr, 0, size -1); } int main() { int arr[] = {23, 11, 24, 5, 67, 2, 4}; int size = sizeof(arr) / sizeof(arr[0]); show(arr, size); quickSort(arr, size); show(arr, size); }  ","date":"2018-07-07","permalink":"https://nautilis.github.io/posts/sort-algorithm/","tags":["sort"],"title":"æ’åºç®—æ³•"}]